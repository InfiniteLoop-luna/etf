# ETFæ•°æ®åº“æ–¹æ¡ˆæ€»ç»“

## ğŸ“¦ å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. æ•°æ®åº“è¡¨ç»“æ„
- **[database/schema.sql](database/schema.sql)** - PostgreSQLè¡¨ç»“æ„å’Œç´¢å¼•
- **[database/schema_sqlite.sql](database/schema_sqlite.sql)** - SQLiteè¡¨ç»“æ„å’Œç´¢å¼•

### 2. æ•°æ®å¯¼å…¥å·¥å…·
- **[database/import_data.py](database/import_data.py)** - æ•°æ®å¯¼å…¥è„šæœ¬ï¼ˆæ”¯æŒSQLiteå’ŒPostgreSQLï¼‰
- **[database/quickstart.py](database/quickstart.py)** - å¿«é€Ÿå¼€å§‹è„šæœ¬ï¼ˆäº¤äº’å¼ï¼‰

### 3. åº”ç”¨ç¨‹åº
- **[src/db_loader.py](src/db_loader.py)** - æ•°æ®åº“æ•°æ®åŠ è½½å™¨
- **[app_with_db.py](app_with_db.py)** - æ”¯æŒæ•°æ®åº“çš„Streamlitåº”ç”¨

### 4. æ–‡æ¡£
- **[database/README.md](database/README.md)** - å®Œæ•´ä½¿ç”¨æŒ‡å—
- **[database/requirements.txt](database/requirements.txt)** - æ•°æ®åº“ä¾èµ–

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡å†³ç­–

### 1. é•¿è¡¨ vs å®½è¡¨ï¼šé€‰æ‹©é•¿è¡¨ç»“æ„ âœ…

**é•¿è¡¨ç»“æ„ï¼ˆæ¨èï¼‰ï¼š**
```
| code | name | date       | metric_type | value  | is_aggregate |
|------|------|------------|-------------|--------|--------------|
| 510300 | æ²ªæ·±300ETF | 2026-01-01 | æ€»å¸‚å€¼ | 1000.0 | False |
| 510300 | æ²ªæ·±300ETF | 2026-01-02 | æ€»å¸‚å€¼ | 1050.0 | False |
```

**ä¼˜åŠ¿ï¼š**
- âœ… æŸ¥è¯¢çµæ´»ï¼šè½»æ¾ç­›é€‰æ—¥æœŸèŒƒå›´ã€ETFã€æŒ‡æ ‡
- âœ… æ˜“äºæ‰©å±•ï¼šæ·»åŠ æ–°æ—¥æœŸä¸éœ€è¦ä¿®æ”¹è¡¨ç»“æ„
- âœ… é€‚åˆå¯è§†åŒ–ï¼šPlotlyç­‰åº“æ›´å®¹æ˜“å¤„ç†
- âœ… ç´¢å¼•é«˜æ•ˆï¼šå¯ä»¥åˆ›å»ºå¤åˆç´¢å¼• `(code, date, metric_type)`

**å®½è¡¨ç»“æ„ï¼ˆä¸æ¨èï¼‰ï¼š**
```
| code | name | 2026-01-01 | 2026-01-02 | 2026-01-03 | ... |
|------|------|------------|------------|------------|-----|
| 510300 | æ²ªæ·±300ETF | 1000.0 | 1050.0 | 1100.0 | ... |
```

**åŠ£åŠ¿ï¼š**
- âŒ æ¯ä¸ªæ—¥æœŸéœ€è¦ä¸€åˆ—
- âŒ æŸ¥è¯¢æ—¥æœŸèŒƒå›´å¤æ‚
- âŒ ä¸é€‚åˆåŠ¨æ€å¢é•¿çš„æ—¶é—´åºåˆ—

### 2. ç´¢å¼•ç­–ç•¥

åˆ›å»ºäº†4ä¸ªå…³é”®ç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼š

```sql
-- 1. å¤åˆç´¢å¼•ï¼šæœ€å¸¸ç”¨çš„æŸ¥è¯¢æ¨¡å¼ï¼ˆæŒ‰ä»£ç ã€æ—¥æœŸã€æŒ‡æ ‡æŸ¥è¯¢ï¼‰
CREATE INDEX idx_etf_timeseries_code_date_metric
    ON etf_timeseries(code, date, metric_type);

-- 2. æ—¥æœŸç´¢å¼•ï¼šç”¨äºæ—¥æœŸèŒƒå›´ç­›é€‰
CREATE INDEX idx_etf_timeseries_date
    ON etf_timeseries(date);

-- 3. æŒ‡æ ‡ç±»å‹ç´¢å¼•ï¼šç”¨äºæŒ‰æŒ‡æ ‡ç­›é€‰
CREATE INDEX idx_etf_timeseries_metric
    ON etf_timeseries(metric_type);

-- 4. æ±‡æ€»æ•°æ®ç´¢å¼•ï¼šå¿«é€ŸæŸ¥è¯¢æ±‡æ€»è¡Œ
CREATE INDEX idx_etf_timeseries_aggregate
    ON etf_timeseries(is_aggregate, date, metric_type);
```

### 3. Upsertæœºåˆ¶

å®ç°äº†æ™ºèƒ½çš„æ’å…¥æˆ–æ›´æ–°é€»è¾‘ï¼š

**SQLite:**
```python
# å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œç„¶åå†³å®šINSERTæˆ–UPDATE
if exists:
    UPDATE ...
else:
    INSERT ...
```

**PostgreSQL:**
```sql
INSERT INTO etf_timeseries (...)
VALUES (...)
ON CONFLICT (code, date, metric_type) DO UPDATE
SET value = EXCLUDED.value, ...
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1ï¼šä½¿ç”¨å¿«é€Ÿå¼€å§‹è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd database
python quickstart.py
```

æŒ‰ç…§æç¤ºé€‰æ‹©SQLiteæˆ–PostgreSQLï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
2. å¯¼å…¥Excelæ•°æ®
3. æ˜¾ç¤ºå¯¼å…¥ç»Ÿè®¡
4. æä¾›ä¸‹ä¸€æ­¥æ“ä½œæŒ‡å—

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æ‰§è¡Œ

#### SQLiteï¼ˆæœ¬åœ°å¼€å‘ï¼‰

```bash
# 1. å¯¼å…¥æ•°æ®
cd database
python import_data.py

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
# Windows
set DATA_SOURCE=database
set DB_TYPE=sqlite
set DB_PATH=etf_data.db

# Linux/Mac
export DATA_SOURCE=database
export DB_TYPE=sqlite
export DB_PATH=etf_data.db

# 3. è¿è¡Œåº”ç”¨
cd ..
streamlit run app_with_db.py
```

#### PostgreSQLï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# 1. ä¿®æ”¹import_data.pyçš„ä¸»å‡½æ•°ï¼Œè®¾ç½®è¿æ¥å­—ç¬¦ä¸²
# 2. è¿è¡Œå¯¼å…¥
cd database
python import_data.py

# 3. é…ç½®Streamlit secrets
# åˆ›å»º .streamlit/secrets.toml
DATABASE_URL = "postgresql://user:pass@host:5432/db"

# 4. è®¾ç½®ç¯å¢ƒå˜é‡
export DATA_SOURCE=database
export DB_TYPE=postgresql

# 5. è¿è¡Œåº”ç”¨
cd ..
streamlit run app_with_db.py
```

---

## ğŸŒ Streamlit Cloudéƒ¨ç½²æ–¹æ¡ˆ

### âš ï¸ é‡è¦æç¤º

**Streamlit Cloudæ˜¯æ— çŠ¶æ€çš„ï¼ˆephemeralï¼‰ï¼š**
- å®¹å™¨ä¼šå®šæœŸé‡å¯
- æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸æŒä¹…åŒ–
- **SQLiteæ•°æ®åº“æ–‡ä»¶ä¼šåœ¨é‡å¯åä¸¢å¤±**

### æ¨èæ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šç»§ç»­ä½¿ç”¨Excelï¼ˆæœ€ç®€å•ï¼‰âœ…

**é€‚ç”¨åœºæ™¯ï¼š**
- æ•°æ®æ›´æ–°ä¸é¢‘ç¹ï¼ˆæ¯å¤©æˆ–æ¯å‘¨ï¼‰
- æ•°æ®é‡ä¸å¤§ï¼ˆ< 10MBï¼‰
- ä¸éœ€è¦å®æ—¶æ›´æ–°

**æ­¥éª¤ï¼š**
1. å°†Excelæ–‡ä»¶æäº¤åˆ°Gitä»“åº“
2. ä½¿ç”¨ç°æœ‰çš„ `app.py`
3. ç›´æ¥éƒ¨ç½²åˆ°Streamlit Cloud

**ä¼˜ç‚¹ï¼š**
- æ— éœ€é¢å¤–é…ç½®
- éƒ¨ç½²ç®€å•
- æ•°æ®éšä»£ç ä¸€èµ·ç‰ˆæœ¬æ§åˆ¶

#### æ–¹æ¡ˆBï¼šä½¿ç”¨å¤–éƒ¨PostgreSQLï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰âœ…

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦é¢‘ç¹æ›´æ–°æ•°æ®
- æ•°æ®é‡è¾ƒå¤§
- éœ€è¦å¤šä¸ªåº”ç”¨å…±äº«æ•°æ®

**æ¨èçš„PostgreSQLæœåŠ¡ï¼š**
1. **Supabase**ï¼ˆæ¨èï¼‰- å…è´¹å¥—é¤ï¼Œ500MBå­˜å‚¨
2. **ElephantSQL** - å…è´¹å¥—é¤ï¼Œ20MBå­˜å‚¨
3. **Neon** - å…è´¹å¥—é¤ï¼Œ3GBå­˜å‚¨
4. **Railway** - å…è´¹å¥—é¤ï¼Œæœ‰é™é¢åº¦

**æ­¥éª¤ï¼š**

1. åœ¨Supabaseåˆ›å»ºæ•°æ®åº“
2. åœ¨æœ¬åœ°å¯¼å…¥æ•°æ®ï¼š
   ```python
   from database.import_data import import_to_postgresql
   connection_string = "ä½ çš„Supabaseè¿æ¥å­—ç¬¦ä¸²"
   import_to_postgresql('ä¸»è¦ETFåŸºé‡‘ä»½é¢å˜åŠ¨æƒ…å†µ.xlsx', connection_string)
   ```

3. åœ¨Streamlit Cloudé…ç½®secretsï¼ˆ`.streamlit/secrets.toml`ï¼‰ï¼š
   ```toml
   DATABASE_URL = "postgresql://user:pass@host:5432/db"
   ```

4. è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
   ```
   DATA_SOURCE=database
   DB_TYPE=postgresql
   ```

5. åœ¨ `requirements.txt` æ·»åŠ ï¼š
   ```
   psycopg2-binary
   ```

6. éƒ¨ç½² `app_with_db.py`

---

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨æ—¥æœŸæ ¼å¼è½¬æ¢

æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼ï¼š
- Excel datetimeå¯¹è±¡
- `2026/02/02` æ ¼å¼
- `2026-02-02` æ ¼å¼

ç»Ÿä¸€è½¬æ¢ä¸º `YYYY-MM-DD` æ ¼å¼å­˜å‚¨ã€‚

### 2. Upsertæ“ä½œ

æ ¹æ® `(code, date, metric_type)` å”¯ä¸€çº¦æŸï¼š
- å¦‚æœè®°å½•å·²å­˜åœ¨ â†’ æ›´æ–°
- å¦‚æœè®°å½•ä¸å­˜åœ¨ â†’ æ’å…¥

é¿å…é‡å¤æ•°æ®ã€‚

### 3. è¯¦ç»†æ—¥å¿—è¾“å‡º

```
2026-02-06 10:00:00 - INFO - å¼€å§‹ä»Excelå¯¼å…¥æ•°æ®
2026-02-06 10:00:01 - INFO - ä»ExcelåŠ è½½äº† 5000 æ¡è®°å½•
2026-02-06 10:00:02 - INFO - å¯¼å…¥/æ›´æ–°äº† 50 ä¸ªETFåŸºæœ¬ä¿¡æ¯
2026-02-06 10:00:05 - INFO - æ•°æ®å¯¼å…¥å®Œæˆ
2026-02-06 10:00:05 - INFO -   - æ–°å¢è®°å½•: 4500
2026-02-06 10:00:05 - INFO -   - æ›´æ–°è®°å½•: 500
2026-02-06 10:00:05 - INFO -   - å¤±è´¥è®°å½•: 0
```

### 4. çµæ´»çš„æ•°æ®æºåˆ‡æ¢

é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼š
```bash
# ä½¿ç”¨Excel
DATA_SOURCE=excel

# ä½¿ç”¨æ•°æ®åº“
DATA_SOURCE=database
DB_TYPE=sqlite  # æˆ– postgresql
```

---

## ğŸ”§ ç»´æŠ¤å’Œæ›´æ–°

### å®šæœŸæ›´æ–°æ•°æ®

#### æ–¹æ³•1ï¼šæ‰‹åŠ¨è¿è¡Œ

```bash
cd database
python import_data.py
```

#### æ–¹æ³•2ï¼šå®šæ—¶ä»»åŠ¡

**Windowsï¼ˆä»»åŠ¡è®¡åˆ’ç¨‹åºï¼‰ï¼š**
```batch
# update_data.bat
cd d:\Code\etf\database
python import_data.py
```

**Linux/Macï¼ˆcronï¼‰ï¼š**
```bash
# æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ
0 8 * * * cd /path/to/etf/database && python import_data.py
```

#### æ–¹æ³•3ï¼šGitHub Actions

åˆ›å»º `.github/workflows/update_data.yml` å®ç°è‡ªåŠ¨æ›´æ–°ã€‚

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | æŸ¥è¯¢é€Ÿåº¦ | æ•°æ®æŒä¹…åŒ– | éƒ¨ç½²éš¾åº¦ | ç»´æŠ¤æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|---------|-----------|---------|---------|---------|
| **Excel** | â­â­â­ | âœ… Git | â­â­â­â­â­ | ä½ | å°æ•°æ®é‡ï¼Œä½é¢‘æ›´æ–° |
| **SQLite** | â­â­â­â­ | âš ï¸ æœ¬åœ° | â­â­â­â­ | ä½ | æœ¬åœ°å¼€å‘ |
| **PostgreSQL** | â­â­â­â­â­ | âœ… äº‘ç«¯ | â­â­â­ | ä¸­ | ç”Ÿäº§ç¯å¢ƒï¼Œå¤§æ•°æ®é‡ |

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### 1. ä¸ºä»€ä¹ˆé•¿è¡¨æ›´é€‚åˆæ—¶é—´åºåˆ—ï¼Ÿ

æ—¶é—´åºåˆ—æ•°æ®çš„ç‰¹ç‚¹ï¼š
- æ—¶é—´ç»´åº¦åŠ¨æ€å¢é•¿
- éœ€è¦é¢‘ç¹çš„æ—¶é—´èŒƒå›´æŸ¥è¯¢
- éœ€è¦æŒ‰å¤šä¸ªç»´åº¦åˆ†ç»„èšåˆ

é•¿è¡¨ç»“æ„å®Œç¾åŒ¹é…è¿™äº›éœ€æ±‚ã€‚

### 2. ç´¢å¼•çš„é‡è¦æ€§

æ²¡æœ‰ç´¢å¼•ï¼š
```sql
-- å…¨è¡¨æ‰«æï¼Œæ…¢
SELECT * FROM etf_timeseries WHERE code = '510300' AND date = '2026-01-01'
```

æœ‰å¤åˆç´¢å¼•ï¼š
```sql
-- ä½¿ç”¨ç´¢å¼•ï¼Œå¿«
-- ç´¢å¼•: (code, date, metric_type)
SELECT * FROM etf_timeseries WHERE code = '510300' AND date = '2026-01-01'
```

### 3. Streamlit Cloudçš„é™åˆ¶

ç†è§£äº‘å¹³å°çš„ç‰¹æ€§ï¼š
- **æ— çŠ¶æ€**ï¼šå®¹å™¨éšæ—¶å¯èƒ½é‡å¯
- **ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ**ï¼šæœ¬åœ°æ–‡ä»¶ä¸æŒä¹…åŒ–
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å¤–éƒ¨å­˜å‚¨ï¼ˆæ•°æ®åº“ã€å¯¹è±¡å­˜å‚¨ï¼‰

---

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³è¡ŒåŠ¨ï¼š
1. âœ… è¿è¡Œ `python database/quickstart.py` æµ‹è¯•æ•°æ®åº“åŠŸèƒ½
2. âœ… åœ¨æœ¬åœ°è¿è¡Œ `streamlit run app_with_db.py` éªŒè¯åº”ç”¨
3. âœ… é˜…è¯» `database/README.md` äº†è§£è¯¦ç»†é…ç½®

### çŸ­æœŸè®¡åˆ’ï¼š
- é€‰æ‹©é€‚åˆçš„éƒ¨ç½²æ–¹æ¡ˆï¼ˆExcelæˆ–PostgreSQLï¼‰
- é…ç½®Streamlit Cloudéƒ¨ç½²
- è®¾ç½®æ•°æ®æ›´æ–°æœºåˆ¶

### é•¿æœŸä¼˜åŒ–ï¼š
- è€ƒè™‘æ·»åŠ æ•°æ®ç¼“å­˜å±‚
- å®ç°å¢é‡æ›´æ–°æœºåˆ¶
- æ·»åŠ æ•°æ®éªŒè¯å’Œç›‘æ§

---

## ğŸ’¡ å…³é”®æ”¶è·

1. **é•¿è¡¨ç»“æ„**æ˜¯æ—¶é—´åºåˆ—æ•°æ®çš„æœ€ä½³é€‰æ‹©
2. **åˆç†çš„ç´¢å¼•**å¯ä»¥å¤§å¹…æå‡æŸ¥è¯¢æ€§èƒ½
3. **Streamlit Cloud**éœ€è¦å¤–éƒ¨æ•°æ®åº“æ‰èƒ½æŒä¹…åŒ–æ•°æ®
4. **Upsertæœºåˆ¶**ç¡®ä¿æ•°æ®ä¸é‡å¤
5. **çµæ´»çš„æ¶æ„**æ”¯æŒå¤šç§æ•°æ®æº

---

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒ [database/README.md](database/README.md) æˆ–æŸ¥çœ‹ä»£ç æ³¨é‡Šã€‚
