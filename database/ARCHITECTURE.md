# ETF数据库架构图

## 数据流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         数据源层                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  主要ETF基金份额变动情况.xlsx                          │      │
│  │  ┌────────────────────────────────────────────┐      │      │
│  │  │ 代码 │ 名称 │ 2026-01-01 │ 2026-01-02 │ ... │      │      │
│  │  ├────────────────────────────────────────────┤      │      │
│  │  │ 510300 │ 沪深300ETF │ 1000 │ 1050 │ ... │      │      │
│  │  └────────────────────────────────────────────┘      │      │
│  └──────────────────────────────────────────────────────┘      │
│                           │                                     │
└───────────────────────────┼─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据转换层                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  src/data_loader.py                                  │      │
│  │  - 读取Excel文件                                      │      │
│  │  - 检测sections（总市值、份额、变动等）                │      │
│  │  - 转换为长格式DataFrame                              │      │
│  │  - 日期格式标准化                                      │      │
│  │  - 数据清洗和验证                                      │      │
│  └──────────────────────────────────────────────────────┘      │
│                           │                                     │
│                           ▼                                     │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  长格式数据                                            │      │
│  │  ┌────────────────────────────────────────────┐      │      │
│  │  │ code │ name │ date │ metric_type │ value │      │      │
│  │  ├────────────────────────────────────────────┤      │      │
│  │  │ 510300 │ 沪深300ETF │ 2026-01-01 │ 总市值 │ 1000 │      │      │
│  │  │ 510300 │ 沪深300ETF │ 2026-01-02 │ 总市值 │ 1050 │      │      │
│  │  └────────────────────────────────────────────┘      │      │
│  └──────────────────────────────────────────────────────┘      │
│                           │                                     │
└───────────────────────────┼─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据存储层                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐      ┌─────────────────────┐          │
│  │   方案A: Excel      │      │   方案B: 数据库      │          │
│  ├─────────────────────┤      ├─────────────────────┤          │
│  │ - 简单直接          │      │ ┌─────────────────┐ │          │
│  │ - 无需配置          │      │ │  etf_info       │ │          │
│  │ - 适合小数据量      │      │ │  - code (PK)    │ │          │
│  │ - Streamlit Cloud   │      │ │  - name         │ │          │
│  │   友好              │      │ └─────────────────┘ │          │
│  └─────────────────────┘      │ ┌─────────────────┐ │          │
│                               │ │ etf_timeseries  │ │          │
│                               │ │  - id (PK)      │ │          │
│                               │ │  - code (FK)    │ │          │
│                               │ │  - date         │ │          │
│                               │ │  - metric_type  │ │          │
│                               │ │  - value        │ │          │
│                               │ │  - is_aggregate │ │          │
│                               │ └─────────────────┘ │          │
│                               │                     │          │
│                               │ 索引:               │          │
│                               │ - (code,date,metric)│          │
│                               │ - (date)            │          │
│                               │ - (metric_type)     │          │
│                               │ - (is_aggregate)    │          │
│                               └─────────────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      应用层                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  app.py (Excel版本)                                  │      │
│  │  - 直接读取Excel                                      │      │
│  │  - 使用data_loader.py                                │      │
│  │  - 简单部署                                           │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  app_with_db.py (数据库版本)                          │      │
│  │  - 支持Excel和数据库双模式                             │      │
│  │  - 使用db_loader.py                                  │      │
│  │  - 环境变量控制数据源                                  │      │
│  └──────────────────────────────────────────────────────┘      │
│                           │                                     │
└───────────────────────────┼─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      展示层                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐      │
│  │  Streamlit Web界面                                    │      │
│  │  ┌────────────────────────────────────────────┐      │      │
│  │  │  侧边栏                                     │      │      │
│  │  │  - 指标选择器                               │      │      │
│  │  │  - ETF选择器                                │      │      │
│  │  │  - 日期范围滑块                             │      │      │
│  │  │  - 图表类型选择                             │      │      │
│  │  └────────────────────────────────────────────┘      │      │
│  │  ┌────────────────────────────────────────────┐      │      │
│  │  │  主区域                                     │      │      │
│  │  │  - Plotly交互式图表                         │      │      │
│  │  │  - 统计信息表格                             │      │      │
│  │  └────────────────────────────────────────────┘      │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 数据库表关系图

```
┌─────────────────────────┐
│      etf_info           │
├─────────────────────────┤
│ code (PK)               │◄─────┐
│ name                    │      │
│ created_at              │      │
│ updated_at              │      │
└─────────────────────────┘      │
                                 │
                                 │ FK
                                 │
┌─────────────────────────┐      │
│   etf_timeseries        │      │
├─────────────────────────┤      │
│ id (PK)                 │      │
│ code (FK)               │──────┘
│ date                    │
│ metric_type             │
│ value                   │
│ is_aggregate            │
│ created_at              │
│ updated_at              │
├─────────────────────────┤
│ UNIQUE(code, date,      │
│        metric_type)     │
└─────────────────────────┘

索引:
1. idx_etf_timeseries_code_date_metric (code, date, metric_type)
2. idx_etf_timeseries_date (date)
3. idx_etf_timeseries_metric (metric_type)
4. idx_etf_timeseries_aggregate (is_aggregate, date, metric_type)
```

## 部署架构对比

### 方案A: Excel + Streamlit Cloud

```
┌─────────────────────────────────────────────┐
│         GitHub Repository                   │
│  ┌───────────────────────────────────┐      │
│  │ - app.py                          │      │
│  │ - 主要ETF基金份额变动情况.xlsx     │      │
│  │ - src/data_loader.py              │      │
│  │ - requirements.txt                │      │
│  └───────────────────────────────────┘      │
└──────────────────┬──────────────────────────┘
                   │
                   │ Git Push
                   ▼
┌─────────────────────────────────────────────┐
│       Streamlit Cloud                       │
│  ┌───────────────────────────────────┐      │
│  │  Container (Ephemeral)            │      │
│  │  - 自动部署                        │      │
│  │  - 读取Excel文件                   │      │
│  │  - 缓存数据（5分钟）                │      │
│  └───────────────────────────────────┘      │
└──────────────────┬──────────────────────────┘
                   │
                   │ HTTPS
                   ▼
              ┌─────────┐
              │  用户    │
              └─────────┘
```

### 方案B: PostgreSQL + Streamlit Cloud

```
┌─────────────────────────────────────────────┐
│         GitHub Repository                   │
│  ┌───────────────────────────────────┐      │
│  │ - app_with_db.py                  │      │
│  │ - src/db_loader.py                │      │
│  │ - requirements.txt                │      │
│  │   (包含 psycopg2-binary)           │      │
│  └───────────────────────────────────┘      │
└──────────────────┬──────────────────────────┘
                   │
                   │ Git Push
                   ▼
┌─────────────────────────────────────────────┐
│       Streamlit Cloud                       │
│  ┌───────────────────────────────────┐      │
│  │  Container (Ephemeral)            │      │
│  │  - 自动部署                        │      │
│  │  - 读取Secrets                     │      │
│  │  - 连接PostgreSQL                  │      │
│  │  - 缓存查询结果                     │      │
│  └───────────────┬───────────────────┘      │
└────────────────────┼────────────────────────┘
                     │
                     │ SQL Query
                     ▼
┌─────────────────────────────────────────────┐
│    External PostgreSQL                      │
│    (Supabase/ElephantSQL/Neon)              │
│  ┌───────────────────────────────────┐      │
│  │  Database (Persistent)            │      │
│  │  - etf_info                       │      │
│  │  - etf_timeseries                 │      │
│  │  - 索引                            │      │
│  └───────────────────────────────────┘      │
└─────────────────────────────────────────────┘
         ▲
         │
         │ 数据导入（本地运行）
         │
┌────────┴────────┐
│  本地计算机      │
│  - import_data.py│
│  - Excel文件     │
└─────────────────┘
```

## 数据导入流程

```
┌─────────────────────────────────────────────────────────────┐
│  1. 读取Excel                                                │
│     load_etf_data('主要ETF基金份额变动情况.xlsx')             │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 数据转换                                                  │
│     - 检测sections                                           │
│     - 解析日期行                                              │
│     - 转换为长格式                                            │
│     - 日期格式标准化 (YYYY-MM-DD)                             │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 导入ETF基本信息                                           │
│     INSERT OR REPLACE INTO etf_info (code, name)             │
│     VALUES (...)                                             │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 导入时间序列数据（Upsert）                                │
│     ┌─────────────────────────────────────────────┐          │
│     │  对每条记录:                                 │          │
│     │  1. 检查是否存在                             │          │
│     │     (code, date, metric_type)               │          │
│     │  2. 如果存在 → UPDATE                        │          │
│     │     如果不存在 → INSERT                      │          │
│     └─────────────────────────────────────────────┘          │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 输出统计信息                                              │
│     - 新增记录: 4500 条                                       │
│     - 更新记录: 500 条                                        │
│     - 失败记录: 0 条                                          │
└─────────────────────────────────────────────────────────────┘
```

## 查询性能优化

```
查询示例: 获取特定ETF在特定日期范围的总市值数据

┌─────────────────────────────────────────────────────────────┐
│  没有索引 (慢)                                                │
│  SELECT * FROM etf_timeseries                                │
│  WHERE code = '510300'                                       │
│    AND date BETWEEN '2026-01-01' AND '2026-01-31'            │
│    AND metric_type = '总市值'                                │
│                                                              │
│  执行计划: 全表扫描 (Seq Scan)                                │
│  扫描行数: 100,000 行                                         │
│  执行时间: ~500ms                                             │
└─────────────────────────────────────────────────────────────┘

                        ▼ 添加索引

┌─────────────────────────────────────────────────────────────┐
│  有复合索引 (快)                                              │
│  CREATE INDEX idx_etf_timeseries_code_date_metric            │
│      ON etf_timeseries(code, date, metric_type);             │
│                                                              │
│  执行计划: 索引扫描 (Index Scan)                              │
│  扫描行数: 31 行                                              │
│  执行时间: ~5ms                                               │
│                                                              │
│  性能提升: 100倍 ✅                                           │
└─────────────────────────────────────────────────────────────┘
```

## 长表 vs 宽表对比

```
┌─────────────────────────────────────────────────────────────┐
│  宽表结构 (不推荐)                                            │
├─────────────────────────────────────────────────────────────┤
│  code │ name │ 2026-01-01 │ 2026-01-02 │ 2026-01-03 │ ...  │
│  510300│沪深300│  1000.0   │   1050.0   │   1100.0   │ ...  │
│                                                              │
│  问题:                                                        │
│  ❌ 每个日期需要一列                                          │
│  ❌ 添加新日期需要ALTER TABLE                                 │
│  ❌ 查询日期范围复杂                                          │
│  ❌ 不适合时间序列分析                                        │
└─────────────────────────────────────────────────────────────┘

                        ▼ 转换为

┌─────────────────────────────────────────────────────────────┐
│  长表结构 (推荐) ✅                                           │
├─────────────────────────────────────────────────────────────┤
│  code │ name │ date       │ metric_type │ value │ is_agg   │
│  510300│沪深300│2026-01-01 │ 总市值      │ 1000.0│ False    │
│  510300│沪深300│2026-01-02 │ 总市值      │ 1050.0│ False    │
│  510300│沪深300│2026-01-03 │ 总市值      │ 1100.0│ False    │
│                                                              │
│  优势:                                                        │
│  ✅ 添加新日期只需INSERT                                      │
│  ✅ 日期范围查询简单 (WHERE date BETWEEN ...)                 │
│  ✅ 适合时间序列分析                                          │
│  ✅ 可以高效创建索引                                          │
│  ✅ Plotly等可视化库更容易处理                                │
└─────────────────────────────────────────────────────────────┘
```
